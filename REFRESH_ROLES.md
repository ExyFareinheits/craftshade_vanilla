# üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–ª–µ–π Discord - –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è

## ‚úÖ –©–æ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ:

### 1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–ª–µ–π**
- –ü—Ä–∏ –∑–∞—Ö–æ–¥—ñ –Ω–∞ –ø—Ä–æ—Ñ—ñ–ª—å –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è —á–∏ –º–∏–Ω—É–ª–æ –±—ñ–ª—å—à–µ 1 –≥–æ–¥–∏–Ω–∏
- –Ø–∫—â–æ —Ç–∞–∫ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è —Ä–æ–ª—ñ –∑ Discord API
- –ü—Ä–∞—Ü—é—î —Ç–∏—Ö–æ –≤ —Ñ–æ–Ω—ñ (–±–µ–∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å)

### 2. **–ö–Ω–æ–ø–∫–∞ —Ä—É—á–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è**
- –ö–Ω–æ–ø–∫–∞ "–û–Ω–æ–≤–∏—Ç–∏" –ø–æ—Ä—É—á –∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º "–¢–≤–æ—ó —Ä–æ–ª—ñ"
- –ê–Ω—ñ–º–∞—Ü—ñ—è –æ–±–µ—Ä—Ç–∞–Ω–Ω—è –ø—ñ–¥ —á–∞—Å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —É—Å–ø—ñ—Ö/–ø–æ–º–∏–ª–∫—É
- –ú–æ–∂–Ω–∞ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∏ –±—É–¥—å-–∫–æ–ª–∏

### 3. **–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ Supabase —Ç–∞ localStorage**
- –û–Ω–æ–≤–ª–µ–Ω—ñ —Ä–æ–ª—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö
- –¢–∞–∫–æ–∂ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –≤ localStorage (fallback)
- `updated_at` –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è

---

## üéØ –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î:

### **–ü—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó:**
```
1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ª–æ–≥—ñ–Ω–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ Discord
2. –û—Ç—Ä–∏–º—É—î–º–æ access_token
3. –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç–æ–∫–µ–Ω –≤ localStorage
4. –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —á–∞—Å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è (roles_last_update)
```

### **–ü—Ä–∏ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–Ω—ñ –ø—Ä–æ—Ñ—ñ–ª—é:**
```
1. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –º–∏–Ω—É–ª–æ > 1 –≥–æ–¥ –∑ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
2. –Ø–∫—â–æ —Ç–∞–∫:
   - –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π access_token
   - –ó–∞–ø–∏—Ç—É—î–º–æ Discord API: /users/@me/guilds/{guildId}/member
   - –û—Ç—Ä–∏–º—É—î–º–æ —Å–≤—ñ–∂—ñ —Ä–æ–ª—ñ
   - –û–Ω–æ–≤–ª—é—î–º–æ –≤ Supabase
   - –û–Ω–æ–≤–ª—é—î–º–æ –≤ localStorage
   - –û–Ω–æ–≤–ª—é—î–º–æ —á–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
```

### **–ü—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ "–û–Ω–æ–≤–∏—Ç–∏":**
```
1. –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è "–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–ª–µ–π..."
2. –ê–Ω—ñ–º–∞—Ü—ñ—è –æ–±–µ—Ä—Ç–∞–Ω–Ω—è —ñ–∫–æ–Ω–∫–∏
3. –ó–∞–ø–∏—Ç –¥–æ Discord API
4. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –ë–î
5. –ü–æ–∫–∞–∑—É—î–º–æ "‚úÖ –†–æ–ª—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ!" –∞–±–æ "‚ùå –ü–æ–º–∏–ª–∫–∞"
```

---

## üìÇ –°—Ç–≤–æ—Ä–µ–Ω—ñ —Ñ–∞–π–ª–∏:

### 1. **`src/lib/refreshRoles.ts`**
–§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–ª–µ–π:
- `refreshUserRoles(discordId)` - –æ–Ω–æ–≤–ª—é—î —Ä–æ–ª—ñ –∑ Discord API
- `shouldRefreshRoles()` - –ø–µ—Ä–µ–≤—ñ—Ä—è—î —á–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ–Ω–æ–≤–∏—Ç–∏
- `markRolesUpdated()` - –∑–±–µ—Ä—ñ–≥–∞—î —á–∞—Å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è

### 2. **`api/user/refresh-roles.ts`** (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
–°–µ—Ä–≤–µ—Ä–Ω–∏–π endpoint –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–ª–µ–π —á–µ—Ä–µ–∑ Bot Token.
‚ö†Ô∏è –ü–æ—Ç—Ä–µ–±—É—î `DISCORD_BOT_TOKEN` –≤ env –∑–º—ñ–Ω–Ω–∏—Ö.

---

## üîß –©–æ –¥–æ–¥–∞–ª–æ—Å—å –≤ —ñ—Å–Ω—É—é—á—ñ —Ñ–∞–π–ª–∏:

### **`CallbackPage.tsx`:**
```typescript
// –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è access token –¥–ª—è –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
localStorage.setItem('discord_access_token', access_token);
localStorage.setItem('roles_last_update', Date.now().toString());
```

### **`ProfilePage.tsx`:**
- –Ü–º–ø–æ—Ä—Ç `FaSyncAlt` —Ç–∞ —Ñ—É–Ω–∫—Ü—ñ–π –∑ `refreshRoles.ts`
- –°—Ç–∞–Ω `isRefreshing` —Ç–∞ `refreshMessage`
- –§—É–Ω–∫—Ü—ñ—è `handleRefreshRoles(silent: boolean)`
- useEffect –∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—é –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
- –ö–Ω–æ–ø–∫–∞ "–û–Ω–æ–≤–∏—Ç–∏" –≤ UI

### **`ProfilePage.scss`:**
- –ö–ª–∞—Å `.refresh-roles-btn` –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é
- –ö–ª–∞—Å `.refresh-message` –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
- –ê–Ω—ñ–º–∞—Ü—ñ—è `@keyframes spin` –¥–ª—è –æ–±–µ—Ä—Ç–∞–Ω–Ω—è —ñ–∫–æ–Ω–∫–∏
- –ö–ª–∞—Å `.profile-card__section-header` –¥–ª—è layout

---

## üé® UI Features:

### **–ö–Ω–æ–ø–∫–∞ "–û–Ω–æ–≤–∏—Ç–∏":**
- üîµ –°–∏–Ω—è –∑ –≥—Ä–∞–¥—ñ—î–Ω—Ç–æ–º
- üîÑ –Ü–∫–æ–Ω–∫–∞ –æ–±–µ—Ä—Ç–∞—î—Ç—å—Å—è –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ
- ‚ú® Hover –µ—Ñ–µ–∫—Ç –∑ –ø—ñ–¥–Ω—è—Ç—Ç—è–º
- üö´ Disabled —Å—Ç–∞–Ω –ø—ñ–¥ —á–∞—Å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è

### **–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:**
- ‚úÖ **–£—Å–ø—ñ—Ö:** –∑–µ–ª–µ–Ω–∏–π —Ñ–æ–Ω, "‚úÖ –†–æ–ª—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ!"
- ‚ùå **–ü–æ–º–∏–ª–∫–∞:** —á–µ—Ä–≤–æ–Ω–∏–π —Ñ–æ–Ω, —Ç–µ–∫—Å—Ç –ø–æ–º–∏–ª–∫–∏
- üé≠ –ü–ª–∞–≤–Ω–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è –ø–æ—è–≤–∏/–∑–Ω–∏–∫–Ω–µ–Ω–Ω—è
- ‚è∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–Ω–∏–∫–∞—é—Ç—å —á–µ—Ä–µ–∑ 3-5 —Å–µ–∫

---

## ‚ö†Ô∏è –û–±–º–µ–∂–µ–Ω–Ω—è Discord API:

### **Access Token Expiration:**
Discord OAuth —Ç–æ–∫–µ–Ω–∏ –¥—ñ—é—Ç—å **7 –¥–Ω—ñ–≤** (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º).

**–©–æ —Å—Ç–∞–Ω–µ—Ç—å—Å—è –ø—ñ—Å–ª—è –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è —Ç–µ—Ä–º—ñ–Ω—É –¥—ñ—ó:**
- –ü—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ "–û–Ω–æ–≤–∏—Ç–∏" - –ø–æ–º–∏–ª–∫–∞ 401
- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: "–¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –∑–∞—Å—Ç–∞—Ä—ñ–≤. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É."
- –ü–æ—Ç—Ä—ñ–±–Ω–æ **–ø–µ—Ä–µ–ª–æ–≥—ñ–Ω–∏—Ç–∏—Å—å** —á–µ—Ä–µ–∑ Discord

**–†—ñ—à–µ–Ω–Ω—è:**
1. –ü–µ—Ä–µ–ª–æ–≥—ñ–Ω–∏—Ç–∏—Å—å (–æ—Ç—Ä–∏–º–∞—Ç–∏ –Ω–æ–≤–∏–π —Ç–æ–∫–µ–Ω)
2. –ê–±–æ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ refresh token mechanism (—Å–∫–ª–∞–¥–Ω—ñ—à–µ)

### **Rate Limits:**
Discord API –º–∞—î –ª—ñ–º—ñ—Ç–∏:
- ~50 –∑–∞–ø–∏—Ç—ñ–≤ –Ω–∞ —Å–µ–∫—É–Ω–¥—É –Ω–∞ endpoint
- –î–ª—è –∑–≤–∏—á–∞–π–Ω–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ü–µ –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞

---

## ü§ñ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: Discord Bot (–º–∞–π–±—É—Ç–Ω—î)

–Ø–∫—â–æ —Ö–æ—á–µ—à **real-time** –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –±–µ–∑ –ø–µ—Ä–µ–ª–æ–≥—ñ–Ω—É:

### **–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–æ—Ç–∞:**
1. Discord Developer Portal ‚Üí New Application ‚Üí Bot
2. –£–≤—ñ–º–∫–Ω—É—Ç–∏ `SERVER MEMBERS INTENT`
3. –î–æ–¥–∞—Ç–∏ –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
4. –ó–±–µ—Ä–µ–≥—Ç–∏ Bot Token –≤ `.env`

### **–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:**
```typescript
// –í api/user/refresh-roles.ts
headers: {
  Authorization: `Bot ${process.env.DISCORD_BOT_TOKEN}`
}
```

### **–ü–µ—Ä–µ–≤–∞–≥–∏ –±–æ—Ç–∞:**
- ‚úÖ –ù–µ –ø–æ—Ç—Ä–µ–±—É—î user access token
- ‚úÖ –ù–µ –º–∞—î expiration
- ‚úÖ –ú–æ–∂–Ω–∞ —Å–ª—É—Ö–∞—Ç–∏ –ø–æ–¥—ñ—ó (GUILD_MEMBER_UPDATE)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ä–æ–ª–µ–π

---

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è:

### **1. –ü–µ—Ä–µ–≤—ñ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:**
```bash
# 1. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Å—è —á–µ—Ä–µ–∑ Discord
# 2. –ó–∞–π–¥–∏ –Ω–∞ –ø—Ä–æ—Ñ—ñ–ª—å - –ø–æ–±–∞—á–∏—à —Ä–æ–ª—ñ
# 3. –í –∫–æ–Ω—Å–æ–ª—ñ –≤–∏–∫–æ–Ω–∞–π:
localStorage.setItem('roles_last_update', '0')
# 4. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂ —Å—Ç–æ—Ä—ñ–Ω–∫—É - —Ä–æ–ª—ñ –º–∞—é—Ç—å –æ–Ω–æ–≤–∏—Ç–∏—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
```

### **2. –ü–µ—Ä–µ–≤—ñ—Ä —Ä—É—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:**
```bash
# 1. –ó–∞–π–¥–∏ –Ω–∞ –ø—Ä–æ—Ñ—ñ–ª—å
# 2. –ù–∞—Ç–∏—Å–Ω–∏ –∫–Ω–æ–ø–∫—É "–û–Ω–æ–≤–∏—Ç–∏"
# 3. –ü–æ–±–∞—á–∏—à –∞–Ω—ñ–º–∞—Ü—ñ—é —Ç–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è "‚úÖ –†–æ–ª—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ!"
```

### **3. –ü–µ—Ä–µ–≤—ñ—Ä –∑–º—ñ–Ω—É —Ä–æ–ª–µ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ:**
```bash
# 1. –ü–æ–ø—Ä–æ—Å–∏ –∞–¥–º—ñ–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏ —Ç–≤–æ—ó —Ä–æ–ª—ñ –Ω–∞ Discord —Å–µ—Ä–≤–µ—Ä—ñ
# 2. –ù–∞—Ç–∏—Å–Ω–∏ "–û–Ω–æ–≤–∏—Ç–∏" –Ω–∞ –ø—Ä–æ—Ñ—ñ–ª—ñ
# 3. –ù–æ–≤—ñ —Ä–æ–ª—ñ –º–∞—é—Ç—å –∑'—è–≤–∏—Ç–∏—Å—å –Ω–∞ —Å–∞–π—Ç—ñ
```

### **4. –ü–µ—Ä–µ–≤—ñ—Ä expired token:**
```bash
# –í –∫–æ–Ω—Å–æ–ª—ñ –±—Ä–∞—É–∑–µ—Ä–∞:
localStorage.setItem('discord_access_token', 'invalid_token')
# –ù–∞—Ç–∏—Å–Ω–∏ "–û–Ω–æ–≤–∏—Ç–∏" - –ø–æ–±–∞—á–∏—à –ø–æ–º–∏–ª–∫—É –ø—Ä–æ –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏–π —Ç–æ–∫–µ–Ω
```

---

## üìä –©–æ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ localStorage:

```javascript
{
  "discord_user": { ... }, // –î–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  "discord_access_token": "...", // OAuth —Ç–æ–∫–µ–Ω (7 –¥–Ω—ñ–≤)
  "roles_last_update": "1699401234567" // Timestamp –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
}
```

---

## üöÄ –î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω—É:

1. **–î–æ–¥–∞–π –≤ Vercel env:**
   ```env
   DISCORD_BOT_TOKEN=—Ç–≤—ñ–π-bot-token (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
   ```

2. **–ù–∞–ª–∞—à—Ç—É–π Bot Intents** (—è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à –±–æ—Ç–∞):
   - SERVER MEMBERS INTENT
   - GUILD MEMBERS

3. **Rate Limiting:**
   - –î–æ–¥–∞–π –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ —Å–ø–∞–º—É (–Ω–∞–ø—Ä. 1 –∑–∞–ø–∏—Ç –Ω–∞ —Ö–≤–∏–ª–∏–Ω—É)

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç:

‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –æ–Ω–æ–≤–∏—Ç–∏ —Å–≤–æ—ó —Ä–æ–ª—ñ –±—É–¥—å-–∫–æ–ª–∏
‚úÖ –†–æ–ª—ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è —Ä–∞–∑ –Ω–∞ –≥–æ–¥–∏–Ω—É
‚úÖ –ü—Ä–∞—Ü—é—î –±–µ–∑ bot token (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î user token)
‚úÖ –ö—Ä–∞—Å–∏–≤–∏–π UI –∑ –∞–Ω—ñ–º–∞—Ü—ñ—è–º–∏
‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —É—Å–ø—ñ—Ö/–ø–æ–º–∏–ª–∫—É
‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ Supabase + localStorage

‚ö†Ô∏è –û–±–º–µ–∂–µ–Ω–Ω—è: —Ç–æ–∫–µ–Ω –¥—ñ–π—Å–Ω–∏–π 7 –¥–Ω—ñ–≤, –ø–æ—Ç—ñ–º —Ç—Ä–µ–±–∞ –ø–µ—Ä–µ–ª–æ–≥—ñ–Ω–∏—Ç–∏—Å—å

---

**–ü–∏—Ç–∞–Ω–Ω—è? –ü–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞ –∑ Discord Bot –¥–ª—è real-time –æ–Ω–æ–≤–ª–µ–Ω—å?** ü§ñ
